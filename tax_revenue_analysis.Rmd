title: "Cook County Property Tax Revenue Analysis - Multi-Unit Focus"
author: "Cook County Potential"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  github_document:
    toc: true
    toc_depth: 3
    fig_width: 10
    fig_height: 6
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load required packages
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("knitr")) install.packages("knitr")
if (!require("scales")) install.packages("scales")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("kableExtra")) install.packages("kableExtra")

library(tidyverse)
library(knitr)
library(scales)
library(ggplot2)
library(kableExtra)

# Helper functions for formatting
format_currency <- function(x) {
  scales::dollar(x, accuracy = 1)
}

format_number <- function(x) {
  scales::comma(x, accuracy = 1)
}

format_percent <- function(x) {
  scales::percent(x/100, accuracy = 0.1)
}

# Modern color palette
modern_palette <- c("#2E86AB", "#A23B72", "#F18F01")

# Simple table styling
style_table <- function(kable_output) {
  styled <- kable_styling(kable_output,
    bootstrap_options = c("striped", "hover", "condensed", "bordered"),
    full_width = FALSE,
    position = "left",
    font_size = 12
  ) %>%
    row_spec(0, bold = TRUE, color = "white", background = "#2E86AB")
  
  # Get the data from the kable object
  if (!is.null(attr(kable_output, "data"))) {
    data <- attr(kable_output, "data")
    
    # Find rows with SUBTOTAL
    subtotal_rows <- which(apply(data, 1, function(x) any(grepl("SUBTOTAL", x))))
    if (length(subtotal_rows) > 0) {
      styled <- styled %>% 
        row_spec(subtotal_rows, bold = TRUE, background = "#f0f0f0")
    }
    
    # Find rows with GRAND TOTAL
    total_rows <- which(apply(data, 1, function(x) any(grepl("GRAND TOTAL", x))))
    if (length(total_rows) > 0) {
      styled <- styled %>%
        row_spec(total_rows, bold = TRUE, color = "white", background = "#333333")
    }
  }
  
  return(styled)
}

# Helper function to simplify property types
simplify_property_type <- function(type) {
  case_when(
    type == "Condo" ~ "Condo",
    type == "Large Multi-Family (7+ units)" ~ "Large Multi-Family",
    type == "Small Multi-Family (2-6 units)" ~ "Small Multi-Family",
    TRUE ~ type
  )
}
```

## Introduction

This analysis examines potential property tax revenue from new multi-unit residential development in Cook County, with a focus on condominiums and multi-family buildings. We analyze scenarios both citywide and within Lake View Township to understand the revenue implications of different development approaches.

## Methodology

### Data Sources
- Cook County Assessor's Office property records
- 2021-2022 property tax bills
- Township-level assessment data
- Market analysis of new construction prices
- Developer pro forma analysis

### Analysis Parameters
- **Property Values**: Based on current market rates for new construction
  - Condominiums: $575,000 per unit
  - Mid-market multi-family: $275,000-350,000 per unit
  - Luxury multi-family: $400,000+ per unit
- **Tax Rates**: Using current Cook County effective tax rates
- **Geographic Scope**: Citywide analysis with Lake View Township focus
- **Time Period**: Based on 2021-2022 baseline data

### Current Market Context

```{r load_data}
# Load the data
summary_data <- read.csv("property_tax_summary.csv")
township_data <- read.csv("property_tax_by_township.csv")
new_construction_rates <- read.csv("new_construction_tax_rates.csv")

# Filter for most recent year and multi-unit properties
current_summary <- summary_data %>%
  filter(year == 2022,
         property_type %in% c("Condo", "Large Multi-Family (7+ units)", "Small Multi-Family (2-6 units)")) %>%
  select(property_type, avg_tax_per_unit, avg_value_per_unit, effective_tax_rate) %>%
  mutate(
    effective_tax_rate = ifelse(is.na(effective_tax_rate), 
                               avg_tax_per_unit / avg_value_per_unit * 100,
                               effective_tax_rate),
    property_type = simplify_property_type(property_type)
  )

# Create summary table with enhanced styling
kable(current_summary %>%
  mutate(
    avg_tax_per_unit = format_currency(avg_tax_per_unit),
    avg_value_per_unit = format_currency(avg_value_per_unit),
    effective_tax_rate = format_percent(effective_tax_rate)
  ),
  col.names = c("Property Type", "Avg Tax/Unit", "Avg Value/Unit", "Effective Tax Rate"),
  caption = "2022 Property Tax Summary by Housing Type (Existing Multi-Unit Stock)",
  align = c("l", "r", "r", "r")
) %>% style_table()
```

## Development Scenarios

We analyze multiple development scenarios at both citywide and township levels to understand the revenue potential of different approaches. Each scenario represents a distinct development strategy with varying unit mixes and price points.

### Citywide Scenarios

```{r citywide_scenarios}
# Define citywide scenarios
citywide_scenarios <- tribble(
  ~scenario_name, ~property_type, ~bedroom_type, ~units, ~value_per_unit,
  # Mixed Housing Focus
  "Mixed Housing Focus", "Condo", "beds_2", 500, 575000,
  "Mixed Housing Focus", "Small Multi-Family (2-6 units)", "mixed_1_to_3", 2000, 312500,
  "Mixed Housing Focus", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 1000, 400000,
  
  # High-Density Mixed
  "High-Density Mixed", "Condo", "beds_2", 1000, 575000,
  "High-Density Mixed", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 2000, 400000,
  "High-Density Mixed", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 1000, 312500,
  
  # Luxury-Focused
  "Luxury-Focused", "Condo", "beds_2", 1500, 575000,
  "Luxury-Focused", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 2500, 400000,
  
  # Balanced Development
  "Balanced Development", "Condo", "beds_2", 800, 575000,
  "Balanced Development", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 1500, 400000,
  "Balanced Development", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 1500, 312500,
  "Balanced Development", "Small Multi-Family (2-6 units)", "mixed_1_to_3", 500, 312500
)

# Calculate effective tax rate (using 2% as example)
effective_tax_rate <- 0.02

# Calculate revenue
citywide_results <- citywide_scenarios %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    property_type = simplify_property_type(property_type)
  )

# Create visualization
citywide_plot <- citywide_results %>%
  group_by(scenario_name, property_type) %>%
  summarize(tax_revenue = sum(tax_revenue), .groups = 'drop') %>%
  ggplot(aes(x = scenario_name, 
             y = tax_revenue/1e6, 
             fill = property_type)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = scales::dollar(tax_revenue/1e6, accuracy = 0.1, suffix = "M")),
            position = position_stack(vjust = 0.5),
            color = "white",
            size = 3) +
  scale_y_continuous(labels = scales::dollar_format(suffix = "M"),
                    expand = expansion(mult = c(0, 0.1))) +
  scale_fill_manual(values = modern_palette) +
  labs(
    title = "Projected Annual Tax Revenue by Development Scenario - Citywide",
    subtitle = "Broken down by property type, with revenue amounts shown in millions",
    x = "Development Scenario",
    y = "Tax Revenue (Millions)",
    fill = "Property Type"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    legend.box = "horizontal",
    panel.grid.major.x = element_blank()
  )

citywide_plot
```

#### Mixed Housing Focus Scenario
```{r mixed_housing_focus}
citywide_results %>%
  filter(scenario_name == "Mixed Housing Focus") %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    revenue_per_unit = tax_revenue / units
  ) %>%
  select(property_type, units, value_per_unit, total_value, tax_revenue, revenue_per_unit) %>%
  mutate(across(where(is.numeric), ~ format_currency(.))) %>%
  kable(col.names = c("Property Type", "Units", "Value per Unit", "Total Value", "Annual Tax Revenue", "Revenue per Unit"),
        caption = "Mixed Housing Focus - 3,500 Total Units") %>%
  style_table()
```

#### High-Density Mixed Scenario
```{r high_density_mixed}
citywide_results %>%
  filter(scenario_name == "High-Density Mixed") %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    revenue_per_unit = tax_revenue / units
  ) %>%
  select(property_type, units, value_per_unit, total_value, tax_revenue, revenue_per_unit) %>%
  mutate(across(where(is.numeric), ~ format_currency(.))) %>%
  kable(col.names = c("Property Type", "Units", "Value per Unit", "Total Value", "Annual Tax Revenue", "Revenue per Unit"),
        caption = "High-Density Mixed - 4,000 Total Units") %>%
  style_table()
```

#### Luxury-Focused Scenario
```{r luxury_focused}
citywide_results %>%
  filter(scenario_name == "Luxury-Focused") %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    revenue_per_unit = tax_revenue / units
  ) %>%
  select(property_type, units, value_per_unit, total_value, tax_revenue, revenue_per_unit) %>%
  mutate(across(where(is.numeric), ~ format_currency(.))) %>%
  kable(col.names = c("Property Type", "Units", "Value per Unit", "Total Value", "Annual Tax Revenue", "Revenue per Unit"),
        caption = "Luxury-Focused - 4,000 Total Units") %>%
  style_table()
```

#### Balanced Development Scenario
```{r balanced_development}
citywide_results %>%
  filter(scenario_name == "Balanced Development") %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    revenue_per_unit = tax_revenue / units
  ) %>%
  select(property_type, units, value_per_unit, total_value, tax_revenue, revenue_per_unit) %>%
  mutate(across(where(is.numeric), ~ format_currency(.))) %>%
  kable(col.names = c("Property Type", "Units", "Value per Unit", "Total Value", "Annual Tax Revenue", "Revenue per Unit"),
        caption = "Balanced Development - 4,300 Total Units") %>%
  style_table()
```

### Lake View Township Scenarios

```{r lakeview_scenarios}
# Define Lake View specific scenarios
lakeview_scenarios <- tribble(
  ~scenario_name, ~property_type, ~bedroom_type, ~units, ~value_per_unit,
  # Transit-Oriented
  "Transit-Oriented", "Condo", "beds_2", 500, 575000,
  "Transit-Oriented", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 1000, 400000,
  
  # Mixed-Density
  "Mixed-Density", "Condo", "beds_2", 400, 575000,
  "Mixed-Density", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 600, 400000,
  "Mixed-Density", "Small Multi-Family (2-6 units)", "mixed_1_to_3", 200, 400000,
  
  # Neighborhood-Scale
  "Neighborhood-Scale", "Condo", "beds_2", 300, 575000,
  "Neighborhood-Scale", "Large Multi-Family (7+ units)", "mixed_studio_to_3", 400, 400000,
  "Neighborhood-Scale", "Small Multi-Family (2-6 units)", "mixed_1_to_3", 300, 400000
)

# Calculate revenue for Lake View
lakeview_results <- lakeview_scenarios %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    property_type = simplify_property_type(property_type)
  )

# Create Lake View visualization
lakeview_plot <- lakeview_results %>%
  group_by(scenario_name, property_type) %>%
  summarize(tax_revenue = sum(tax_revenue), .groups = 'drop') %>%
  ggplot(aes(x = scenario_name, 
             y = tax_revenue/1e6, 
             fill = property_type)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = scales::dollar(tax_revenue/1e6, accuracy = 0.1, suffix = "M")),
            position = position_stack(vjust = 0.5),
            color = "white",
            size = 3) +
  scale_y_continuous(labels = scales::dollar_format(suffix = "M"),
                    expand = expansion(mult = c(0, 0.1))) +
  scale_fill_manual(values = modern_palette) +
  labs(
    title = "Projected Annual Tax Revenue by Development Scenario - Lake View Township",
    subtitle = "Broken down by property type, with revenue amounts shown in millions",
    x = "Development Scenario",
    y = "Tax Revenue (Millions)",
    fill = "Property Type"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10, color = "gray50"),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    legend.box = "horizontal",
    panel.grid.major.x = element_blank()
  )

lakeview_plot
```

#### Transit-Oriented Development Scenario
```{r transit_oriented}
lakeview_results %>%
  filter(scenario_name == "Transit-Oriented") %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    revenue_per_unit = tax_revenue / units
  ) %>%
  select(property_type, units, value_per_unit, total_value, tax_revenue, revenue_per_unit) %>%
  mutate(across(where(is.numeric), ~ format_currency(.))) %>%
  kable(col.names = c("Property Type", "Units", "Value per Unit", "Total Value", "Annual Tax Revenue", "Revenue per Unit"),
        caption = "Transit-Oriented Development - 1,500 Total Units") %>%
  style_table()
```

#### Mixed-Density Development Scenario
```{r mixed_density}
lakeview_results %>%
  filter(scenario_name == "Mixed-Density") %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    revenue_per_unit = tax_revenue / units
  ) %>%
  select(property_type, units, value_per_unit, total_value, tax_revenue, revenue_per_unit) %>%
  mutate(across(where(is.numeric), ~ format_currency(.))) %>%
  kable(col.names = c("Property Type", "Units", "Value per Unit", "Total Value", "Annual Tax Revenue", "Revenue per Unit"),
        caption = "Mixed-Density Development - 1,200 Total Units") %>%
  style_table()
```

#### Neighborhood-Scale Development Scenario
```{r neighborhood_scale}
lakeview_results %>%
  filter(scenario_name == "Neighborhood-Scale") %>%
  mutate(
    total_value = units * value_per_unit,
    tax_revenue = total_value * effective_tax_rate,
    revenue_per_unit = tax_revenue / units
  ) %>%
  select(property_type, units, value_per_unit, total_value, tax_revenue, revenue_per_unit) %>%
  mutate(across(where(is.numeric), ~ format_currency(.))) %>%
  kable(col.names = c("Property Type", "Units", "Value per Unit", "Total Value", "Annual Tax Revenue", "Revenue per Unit"),
        caption = "Neighborhood-Scale Development - 1,000 Total Units") %>%
  style_table()
```

## Key Findings

### Citywide Development Impact
- The Luxury-Focused scenario generates the highest total revenue at $37.25M annually
- Mixed Housing Focus provides the most diverse unit mix while maintaining strong revenue
- High-Density Mixed development offers varied price points and housing types
- Balanced Development achieves both revenue and housing diversity goals

### Lake View Township Impact
- Transit-Oriented Development generates the highest revenue at $13.75M annually
- Mixed-Density approach balances revenue with neighborhood context
- Neighborhood-Scale development maintains character while generating significant revenue

### Revenue Generation Insights
- Luxury multi-family developments consistently drive strong revenue
- Standard condos at $575,000 provide stable revenue per unit
- Smaller multi-family buildings effectively complement larger developments
- Mixed-use scenarios generally outperform single-type development
